name: "Docs - Deploy"

on:
  workflow_call:
  workflow_dispatch:

jobs:
  checks:
    name: environment
    uses: ./.github/workflows/checks.yml
    secrets: inherit

  deploy-docs:
    name: deploy-docs
    runs-on: ubuntu-latest
    needs: [checks]
    environment:
      name: ${{ needs.checks.outputs.env_name }}
    if: ${{ needs.checks.outputs.docs-changed == 'true' }}
    timeout-minutes : 10
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ðŸŽ¡ Setup Kubectl
        uses: azure/setup-kubectl@v3

      - name: ðŸŽ¡ Set Kubectl Context
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: ðŸŽ¡ Kustomize Bake
        id: bake
        uses: azure/k8s-bake@v2.4
        with:
            renderEngine: 'kustomize'
            kustomizationPath: ${{ github.workspace }}/infra/kustomize/docs/overlays/${{ needs.checks.outputs.env_name }}
      
      - name: ðŸš€ Deploy to k8s
        uses: azure/k8s-deploy@v4
        with:
          # if env_name is v2 then namespace will be v2 else it will be default
          namespace: ${{ needs.checks.outputs.env_name == 'v2' && 'v2' || 'default' }}
          action: deploy
          strategy: basic
          manifests: |
            ${{ steps.bake.outputs.manifestsBundle }}
            ${{ github.workspace }}/infra/k8s/ingress/${{ needs.checks.outputs.env_name }}/ingress.yaml
          images: |
            goatcommunity/docs:${{ needs.checks.outputs.sha_short }}